name: Build and Deploy Web App

on:
  workflow_dispatch:

jobs:
  build-web:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        cache-dependency-path: web_panel/package-lock.json
        
    - name: Install dependencies
      working-directory: web_panel
      run: npm ci
      
    - name: Create environment file
      working-directory: web_panel
      run: |
        echo "REACT_APP_FIREBASE_API_KEY=AIzaSyB0bdUjUA-iBEk6wubRqUkAAqju3BAiZGw" >> .env
        echo "REACT_APP_FIREBASE_AUTH_DOMAIN=irtzalink-4d407.firebaseapp.com" >> .env
        echo "REACT_APP_FIREBASE_PROJECT_ID=irtzalink-4d407" >> .env
        echo "REACT_APP_FIREBASE_STORAGE_BUCKET=irtzalink-4d407.firebasestorage.app" >> .env
        echo "REACT_APP_FIREBASE_MESSAGING_SENDER_ID=342984685133" >> .env
        echo "REACT_APP_FIREBASE_APP_ID=1:342984685133:web:ab735ceb6c3f425ff38e04" >> .env
      
    - name: Lint code
      working-directory: web_panel
      run: npm run lint || true
      
    - name: Build web app
      working-directory: web_panel
      run: npm run build
      env:
        CI: false  # Disable treating warnings as errors
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: IrtzaLink-Web-Build
        path: web_panel/build/
        
    - name: Create deployment info
      run: |
        echo "## IrtzaLink Web App Build" > web_deploy_info.md
        echo "" >> web_deploy_info.md
        echo "### Build Information:" >> web_deploy_info.md
        echo "- Build Date: $(date)" >> web_deploy_info.md
        echo "- Node Version: $(node --version)" >> web_deploy_info.md
        echo "- NPM Version: $(npm --version)" >> web_deploy_info.md
        echo "" >> web_deploy_info.md
        echo "### Features:" >> web_deploy_info.md
        echo "- ðŸŒ Modern React Web Interface" >> web_deploy_info.md
        echo "- ðŸ”¥ Firebase Authentication & Database" >> web_deploy_info.md
        echo "- ðŸŽ¨ Beautiful Dark/Light Theme" >> web_deploy_info.md
        echo "- ðŸ‘¥ Social Media Management" >> web_deploy_info.md
        echo "- ðŸ’¬ Real-time Chat System" >> web_deploy_info.md
        echo "- ðŸ† Follow/Unfollow System" >> web_deploy_info.md
        echo "- âœ… Verified User System" >> web_deploy_info.md
        echo "- ðŸ”§ Admin Panel (Restricted Access)" >> web_deploy_info.md
        echo "- ðŸ“± Responsive Design" >> web_deploy_info.md
        echo "" >> web_deploy_info.md
        echo "### Admin Access:" >> web_deploy_info.md
        echo "- Only authorized admin email can access admin panel" >> web_deploy_info.md
        echo "- Username reset functionality for all users" >> web_deploy_info.md
        echo "- Enhanced security with double confirmation" >> web_deploy_info.md
        
    - name: Upload deployment info
      uses: actions/upload-artifact@v4
      with:
        name: Web-Deployment-Info
        path: web_deploy_info.md

  # Optional: Deploy to Vercel (if needed)
  deploy-vercel:
    runs-on: ubuntu-latest
    needs: build-web
    if: github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: IrtzaLink-Web-Build
        path: web_panel/build/
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        
    - name: Install Vercel CLI
      run: npm install -g vercel@latest
      
    - name: Deploy to Vercel
      working-directory: web_panel
      run: |
        echo "Deployment would happen here if Vercel token is configured"
        echo "To enable: Add VERCEL_TOKEN to repository secrets"
        echo "Then uncomment the actual deployment command below"
        # vercel --prod --token ${{ secrets.VERCEL_TOKEN }}
      env:
        VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}